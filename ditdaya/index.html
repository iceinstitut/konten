<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Form Pendaftaran Tendik</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script>
        function loadComponent(id, url) {
    fetch("https://iceinstitut.github.io/konten/" + url)
        .then(response => response.text())
        .then(data => {
            document.getElementById(id).innerHTML = data;
        });
}

document.addEventListener("DOMContentLoaded", function() {
    loadComponent("header", "header.html");
    loadComponent("footer", "footer.html");
});

fetch("https://iceinstitut.github.io/konten/head.html")
    .then(response => response.text())
    .then(data => {
        const temp = document.createElement("div");
        temp.innerHTML = data;

        // Proses <link> langsung
        temp.querySelectorAll("link").forEach(link => {
            document.head.appendChild(link);
        });

        // Proses <script> manual
        temp.querySelectorAll("script").forEach(oldScript => {
            const newScript = document.createElement("script");
            newScript.src = oldScript.src;
            if (oldScript.defer) newScript.defer = true;
            document.head.appendChild(newScript);
        });
    });
</script>
    <style>
        .tendik-wrapper {
            border: 2px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: #fafafa;
        }

        .remove-btn {
            background: red;
            color: white;
            padding: 5px 10px;
            float: right;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .data-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }

        .print-content {
            display: none;
        }
    </style>
</head>

<body>
    <div id="header"></div>
    <div class="container mt-4">
    <div class="px-4 py-5 my-5 text-center">
    <div class="row justify-content-center align-items-center">
    <div class="col-auto">
    	<img class="d-block mx-auto mb-4" src="https://iceinstitut.github.io/image/aset/logo_tutwuri.webp" style="max-height:100px;">
    </div>
    <div class="col-auto">
    	<img class="d-block mx-auto mb-4" src="https://iceinstitut.github.io/image/aset/logo_ditdaya.png" style="max-height:100px;">
    </div>
    <div class="col-auto">
    	<img class="d-block mx-auto mb-4" src="https://iceinstitut.github.io/image/aset/Logo-Diktisaintek-Berdampak.png" style="max-height:100px;">
    </div>
    <div class="col-auto">
    	<img class="d-block mx-auto mb-4" src="https://iceinstitut.github.io/image/aset/ice-institute-logo-symbol.png" style="max-height:100px;">
    </div>
    </div>
    <h1 class="display-5 fw-bold text-body-emphasis">Form Pendaftaran Tendik</h1>
</div>
        <form id="mainForm">
			<!-- INFORMASI PT -->
			<div class="card shadow">
			    <div class="card-body">
			        <h3>Informasi Perguruan Tinggi</h3>
			        <div class="row mb-2">
			            <div class="col-md-3 col-sm-12 mb-2">
			                <label class="form-label">Kode Perguruan Tinggi</label>
			                <input class="form-control" type="text" id="pt_code">
			            </div>
			            <div class="col-md-6 col-sm-12 mb-2">
			                <label class="form-label">Nama Perguruan Tinggi</label>
			                <select class="form-select" id="pt_name"></select>
			            </div>
			            <div class="col-md-3 col-sm-12 mb-2">
			                <label class="form-label">Status Perguruan Tinggi</label>
			                <select class="form-select" id="pt_status">
			                    <option value="">Status Perguruan Tinggi</option>
			                    <option value="PTN">PTN</option>
			                    <option value="PTS">PTS</option>
			                </select>
			            </div>
			            <div class="col-md-12 col-sm-12 mb-2">
			                <label class="form-label">Alamat Perguruan Tinggi</label>
			                <input class="form-control" type="text" id="pt_address">
			            </div>
			            <div class="col-md-4 col-sm-12 mb-2">
			                <label class="form-label">Negara Perguruan Tinggi</label>
			                <select class="form-select" id="pt_country"></select>
			            </div>
			            <div class="col-md-4 col-sm-12 mb-2">
			                <label class="form-label">Provinsi Perguruan Tinggi</label>
			                <select class="form-select" id="pt_province"></select>
			            </div>
			            <div class="col-md-4 col-sm-12 mb-2">
			                <label class="form-label">Kota Perguruan Tinggi</label>
			                <select class="form-select" id="pt_city"></select>
			            </div>
			            <div class="col-md-12 col-sm-12 mb-2">
			                <label class="form-label">Upload Rekomendasi PT (PDF max 1MB)</label>
			                <input class="form-control" type="file" id="pt_recommendation" accept=".pdf,.jpg,.jpeg,.png">
			            </div>
			        </div>
			    </div>
			</div>
            <br>
            <!-- DAFTAR TENDIK -->
            <div class="row mb-3">
                <h3 class="col-auto">Data Tendik (maksimal 7)</h3>
                <button class="col-auto btn btn-secondary" type="button" onclick="addTendik()">Tambah Tendik</button>
            </div>
            <div id="tendikContainer"></div>
            <br><br>
            <button class="btn btn-primary" type="button" onclick="submitForm()">Submit</button>
        </form>
    </div>
    <!-- Hidden print content -->
    <div id="printContent" class="print-content"></div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>
    (async function() {
        // CONFIG
        const API_BASE = "https://script.google.com/macros/s/AKfycbybDIA_RF8K4HTBqN59-bsCW5QtthDkDsfwUwzXZVySIX9q-kPWpn1zXALHFEdKXFDC/exec";
        const MAX_TENDIK = 7;

        // STATE
        let COURSE_DATA = {};
        let bidangList = [];
        let locationData = [];
        let ptList = [];
        let tendikCount = 0;
        let lastSubmittedData = null;

        // SweetAlert Configuration
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // INIT on DOM ready
        document.addEventListener("DOMContentLoaded", init);

        async function init() {
            try {
                await loadPTList();
                await loadLocationData();
                await loadCourseData();

                // Pre-add one tendik block for user convenience
                addTendik();

            } catch (err) {
                console.error("Init error:", err);
                showError("Gagal memuat data awal. Silakan refresh halaman.");
            }
        }

        // ------------- LOAD COURSE DATA -------------
        async function loadCourseData() {
            try {
                const url = API_BASE + "?action=getCourseData";
                const res = await fetch(url);
                const json = await res.json();
                if (json.status === "success") {
                    COURSE_DATA = json.data || {};
                    bidangList = Object.keys(COURSE_DATA);
                } else {
                    COURSE_DATA = {};
                    bidangList = [];
                }
            } catch (err) {
                COURSE_DATA = {};
                bidangList = [];
                console.error("loadCourseData error:", err);
            }
        }

        // ------------- LOAD PT LIST -------------
        async function loadPTList() {
            try {
                const res = await fetch(API_BASE + "?action=getPT");
                const json = await res.json();
                if (json.status === "success") {
                    ptList = json.data || [];
                } else {
                    ptList = [];
                    console.warn("getPT response:", json);
                    showError("Gagal memuat daftar Perguruan Tinggi");
                }
            } catch (err) {
                ptList = [];
                console.error("loadPTList error:", err);
                showError("Gagal memuat daftar Perguruan Tinggi");
            }

            // populate #pt_name select and init select2
            const $pt = $("#pt_name");
            if ($pt.length) {
                $pt.empty();
                $pt.append(new Option("", ""));
                ptList.forEach(pt => $pt.append(new Option(pt, pt)));
                if ($pt.data('select2')) { $pt.select2('destroy'); }
                $pt.select2({ placeholder: "Cari Perguruan Tinggi...", allowClear: true, width: "100%" });
            }
        }

        // ------------- LOAD LOCATION DATA -------------
        async function loadLocationData() {
            try {
                const res = await fetch(API_BASE + "?action=location");
                const json = await res.json();
                if (json.status === "success") {
                    locationData = json.data || [];
                } else {
                    locationData = [];
                    console.warn("location response:", json);
                    showError("Gagal memuat data lokasi");
                }
            } catch (err) {
                locationData = [];
                console.error("loadLocationData error:", err);
                showError("Gagal memuat data lokasi");
            }

            // build country list and init select2 for country select
            const countries = [...new Set(locationData.map(i => i.country).filter(Boolean))];
            const $country = $("#pt_country");
            if ($country.length) {
                $country.empty();
                $country.append(new Option("", ""));
                countries.forEach(c => $country.append(new Option(c, c)));
                if ($country.data('select2')) { $country.select2('destroy'); }
                $country.select2({ placeholder: "Pilih Negara", width: "100%" });
            }

            // attach change handlers
            $("#pt_country").off("change").on("change", function() {
                const selectedCountry = $(this).val();
                const provinces = [...new Set(locationData.filter(i => i.country === selectedCountry).map(i => i.province).filter(Boolean))];

                const $prov = $("#pt_province");
                $prov.empty();
                $prov.append(new Option("", ""));
                provinces.forEach(p => $prov.append(new Option(p, p)));
                if ($prov.data('select2')) { $prov.select2('destroy'); }
                $prov.select2({ placeholder: "Pilih Provinsi", width: "100%" });

                // clear city
                const $city = $("#pt_city");
                $city.empty();
                $city.append(new Option("", ""));
                if ($city.data('select2')) { $city.select2('destroy'); }
                $city.select2({ placeholder: "Pilih Kota", width: "100%" });
            });

            $("#pt_province").off("change").on("change", function() {
                const selectedProvince = $(this).val();
                const cities = [...new Set(locationData.filter(i => i.province === selectedProvince).map(i => i.city).filter(Boolean))];

                const $city = $("#pt_city");
                $city.empty();
                $city.append(new Option("", ""));
                cities.forEach(c => $city.append(new Option(c, c)));
                if ($city.data('select2')) { $city.select2('destroy'); }
                $city.select2({ placeholder: "Pilih Kota", width: "100%" });
            });
        }

        // ------------- ADD / REMOVE TENDIK -------------
        window.addTendik = function() {
            if (tendikCount >= MAX_TENDIK) {
                showWarning(`Maksimal ${MAX_TENDIK} tendik.`);
                return;
            }

            tendikCount++;
            const id = "tendik_" + tendikCount;

            const container = document.getElementById("tendikContainer");
            const wrapper = document.createElement("div");
            wrapper.className = "tendik-wrapper";
            wrapper.id = id;

            wrapper.innerHTML = `
                    <button class="remove-btn" type="button"><i class="bi bi-x-lg"></i></button>
                    <h4>Tendik #${tendikCount}</h4>

	                <div class="row">

		                <div class="col-md-6 col-sm-12 mb-2">
                    <label class="form-label">Modul Pilihan</label>
                    <select class="form-select" id="${id}_course"><option value="">Pilih bidang dulu...</option></select>
		                </div>

	                	<div class="col-md-6 col-sm-12 mb-2">
	                	<label class="form-label">Bidang Tendik</label>
                    <select class="form-select" id="${id}_bidang"><option value="">-- pilih bidang --</option></select>
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
		                <label class="form-label">Nama Tendik</label>
                    <input class="form-control" type="text" id="${id}_nama">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
		                <label class="form-label">NIK Tendik</label>
                    <input class="form-control" type="text" id="${id}_nik">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Jenis Kelamin</label>
                    <select class="form-select" id="${id}_jk">
                        <option value="">-- pilih jenis kelamin --</option>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Tanggal Lahir</label>
                    <input class="form-control" type="date" id="${id}_tgl_lahir">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Whatsapp</label>
                    <input class="form-control" type="text" id="${id}_wa">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Email</label>
                    <input class="form-control" type="email" id="${id}_email">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Jabatan</label>
                    <input class="form-control" type="text" id="${id}_jabatan">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Nomor SK</label>
                    <input class="form-control" type="text" id="${id}_nomor_sk">
		                </div>

		                <div class="col-md-4 col-sm-12 mb-2">
                    <label class="form-label">Tanggal SK</label>
                    <input class="form-control" type="date" id="${id}_tgl_sk">
		                </div>

		                <div class="col-md-12 col-sm-12 mb-2">
                    <label class="form-label">Link SK Tendik (Google Drive/URL)</label>
                    <input class="form-control" type="url" id="${id}_link" placeholder="https://drive.google.com/...">
		                </div>
	                </div>   
                `;

            container.appendChild(wrapper);

            // attach remove button handler
            wrapper.querySelector(".remove-btn").addEventListener("click", function() {
                wrapper.remove();
                tendikCount--;
                showInfo("Tendik berhasil dihapus");
            });

            // populate bidang options
            const bidangSelect = document.getElementById(id + "_bidang");
            bidangList.forEach(b => {
                const opt = document.createElement("option");
                opt.value = b;
                opt.textContent = b;
                bidangSelect.appendChild(opt);
            });

            // attach onchange handler to update course dropdown
            bidangSelect.addEventListener("change", function() {
                updateCourseDropdown(id);
            });
        };

        // ------------- UPDATE COURSE DROPDOWN -------------
        window.updateCourseDropdown = function(id) {
            const bidang = document.getElementById(id + "_bidang").value;
            const courseSelect = document.getElementById(id + "_course");
            courseSelect.innerHTML = "";

            if (!bidang || !COURSE_DATA[bidang] || COURSE_DATA[bidang].length === 0) {
                courseSelect.innerHTML = `<option value="">Pilih bidang dulu...</option>`;
                return;
            }

            COURSE_DATA[bidang].forEach(course => {
                const opt = document.createElement("option");
                opt.value = course;
                opt.textContent = course;
                courseSelect.appendChild(opt);
            });
        };

        // ------------- VALIDATION FUNCTIONS -------------
        function setInvalid(el, msg) {
            el.classList.add("is-invalid");
            el.classList.remove("is-valid");

            let fb = el.parentNode.querySelector(".invalid-feedback");
            if (!fb) {
                fb = document.createElement("div");
                fb.className = "invalid-feedback";
                el.parentNode.appendChild(fb);
            }
            fb.textContent = msg;
        }

        function setValid(el) {
            el.classList.remove("is-invalid");
            el.classList.add("is-valid");
        }

        function isValidEmail(email) {
            return /^\S+@\S+\.\S+$/.test(email);
        }

        function validateNIK(nik) {
            return /^[0-9]{16}$/.test(nik);
        }

        function validateWA(wa) {
            return /^08[0-9]{8,}$/.test(wa);
        }

        // ------------- SWEETALERT HELPERS -------------
        function showLoading() {
            Swal.fire({
                title: 'Memproses...',
                text: 'Sedang menyimpan data',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function showSuccess(submitMessage, data) { // Tambahkan parameter submitMessage
            const successHTML = generateSuccessHTML(submitMessage, data); // Kirim message ke generateSuccessHTML

            Swal.fire({
                title: 'Berhasil!',
                html: successHTML,
                icon: 'success',
                confirmButtonText: 'Tutup',
                showCancelButton: true,
                cancelButtonText: 'Print',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#28a745',
                reverseButtons: true,
                width: '900px'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    // Print button clicked - use iframe method
                    printUsingIframe(data);
                }
            });
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: message,
                confirmButtonColor: '#d33'
            });
        }

        function showWarning(message) {
            Toast.fire({
                icon: 'warning',
                title: message
            });
        }

        function showInfo(message) {
            Toast.fire({
                icon: 'info',
                title: message
            });
        }

        // ------------- GENERATE SUCCESS HTML -------------
        function generateSuccessHTML(message, data) { // Tambahkan parameter message
            const timestamp = new Date().toLocaleString('id-ID');
            const totalTendik = data.tendik.length;

            let tendikHTML = '';
            data.tendik.forEach((t, index) => {
                tendikHTML += `
			            <div class="data-summary" style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
			                <h6 style="margin: 0 0 10px 0; color: #495057;">Tendik #${index + 1}</h6>
			                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em;">
			                    <div><strong>Nama:</strong> ${t.nama}</div>
			                    <div><strong>NIK:</strong> ${t.nik}</div>
			                    <div><strong>Bidang:</strong> ${t.bidang}</div>
			                    <div><strong>Modul:</strong> ${t.course}</div>
			                    <div><strong>Jabatan:</strong> ${t.jabatan}</div>
			                    <div><strong>Email:</strong> ${t.email}</div>
			                </div>
			            </div>
			        `;
            });

            return `
			        <div style="text-align: left; max-height: 60vh; overflow-y: auto;">
			            <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
			                <h5 style="color: #155724; margin: 0;">${message}</h5>  <!-- Gunakan parameter message di sini -->
			                <p style="margin: 5px 0 0 0; color: #0c5460; font-size: 0.9em;">
			                    <strong>Waktu Submit:</strong> ${timestamp} | 
			                    <strong>Total Tendik:</strong> ${totalTendik} orang
			                </p>
			            </div>
			            
			            <div class="data-summary">
			                <h5 style="color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px;">Data Perguruan Tinggi</h5>
			                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
			                    <div><strong>Nama Perguruan Tinggi:</strong> ${data.pt.name}</br>
			                    <div><strong>Kode Perguruan Tinggi:</strong> ${data.pt.code}</div>
			                    <div><strong>Status:</strong> ${data.pt.status}</div>
			                    <div><strong>Alamat:</strong> ${data.pt.address}</div>
			                    <div><strong>Lokasi:</strong> ${data.pt.city}, ${data.pt.province}, ${data.pt.country}</div>
			                    <div><strong>File Rekomendasi:</strong> ${data.pt.hasFile ? '‚úì Terupload' : 'Tidak ada'}</div>
			                </div>
			            </div>

			            <div class="data-summary">
			                <h5 style="color: #495057; border-bottom: 2px solid #28a745; padding-bottom: 5px;">
			                    Data Tendik (${totalTendik} orang)
			                </h5>
			                ${tendikHTML}
			            </div>

			            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 15px;">
			                <p style="margin: 0; color: #856404; font-size: 0.9em;">
			                    <strong>Note:</strong> Data telah berhasil disimpan. Klik "Print" untuk mencetak sebagai bukti Anda telah mengisi atau "Tutup" untuk menutup dialog.
			                </p>
			            </div>
			        </div>
			    `;
        }

        // ------------- PRINT USING IFRAME (MORE RELIABLE) -------------
        function printUsingIframe(data) {
            const timestamp = new Date().toLocaleString('id-ID');
            const totalTendik = data.tendik.length;

            let tendikPrintHTML = '';
            data.tendik.forEach((t, index) => {
                tendikPrintHTML += `
            <div style="border: 1px solid #000; padding: 15px; margin: 10px 0; page-break-inside: avoid;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;">
                    Tendik #${index + 1}
                </h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; width: 25%; background: #f8f9fa;"><strong>Nama</strong></td>
                        <td style="padding: 8px; border: 1px solid #000; width: 75%;">${t.nama}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>NIK</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.nik}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Bidang</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.bidang}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Jenis Kelamin</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.jk}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Tanggal Lahir</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.tgl_lahir}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>WhatsApp</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.whatsapp}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Email</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.email}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Jabatan</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.jabatan}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Nomor SK</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.nomor_sk}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Tanggal SK</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.tgl_sk}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Modul Pilihan</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">${t.course}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #000; background: #f8f9fa;"><strong>Link SK</strong></td>
                        <td style="padding: 8px; border: 1px solid #000;">
                            ${t.link ? 
                                `<a href="${t.link}" target="_blank" style="word-break: break-all;">${t.link}</a>` : 
                                'Tidak ada link'
                            }
                        </td>
                    </tr>
                </table>
            </div>
        `;
            });

            const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Bukti Pendaftaran Tendik</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    color: #000; 
                }
                h1, h2, h3, h4 { color: #2c3e50; }
                table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                td { padding: 8px; border: 1px solid #000; }
                .header { text-align: center; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 10px; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 3px double #000; text-align: center; font-style: italic; }
                a { color: #0066cc; text-decoration: underline; }
                @media print {
                    a { color: #000 !important; text-decoration: underline !important; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 style="margin: 0;">FORM PENDAFTARAN TENAGA KEPENDIDIKAN</h1>
                <h3 style="margin: 5px 0;">Bukti Pendaftaran</h3>
                <p style="margin: 0; font-size: 0.9em;">Waktu Submit: ${timestamp}</p>
            </div>

            <div style="margin-bottom: 20px;">
                <h2 style="border-bottom: 2px solid #3498db; padding-bottom: 5px;">Data Perguruan Tinggi</h2>
                <table>
                    <tr>
                        <td style="width: 30%; background: #f8f9fa;"><strong>Nama Perguruan Tinggi</strong></td>
                        <td style="width: 70%;">${data.pt.name}</td>
                    </tr>
                    <tr>
                        <td style="background: #f8f9fa;"><strong>Kode Perguruan Tinggi</strong></td>
                        <td>${data.pt.code}</td>
                    </tr>
                    <tr>
                        <td style="background: #f8f9fa;"><strong>Status</strong></td>
                        <td>${data.pt.status}</td>
                    </tr>
                    <tr>
                        <td style="background: #f8f9fa;"><strong>Alamat</strong></td>
                        <td>${data.pt.address}</td>
                    </tr>
                    <tr>
                        <td style="background: #f8f9fa;"><strong>Lokasi</strong></td>
                        <td>${data.pt.city}, ${data.pt.province}, ${data.pt.country}</td>
                    </tr>
                    <tr>
					    <td style="background: #f8f9fa;"><strong>File Rekomendasi</strong></td>
					    <td>
					        ${data.pt.recommendationLink ? 
					            `<a href="${data.pt.recommendationLink}" target="_blank" style="word-break: break-all;">${data.pt.recommendationLink}</a>` : 
					            'Tidak ada file rekomendasi'
					        }
					    </td>
					</tr>
                </table>
            </div>

            <div>
                <h2 style="border-bottom: 2px solid #27ae60; padding-bottom: 5px;">
                    Data Tenaga Kependidikan (${totalTendik} orang)
                </h2>
                ${tendikPrintHTML}
            </div>

            <div class="footer">
                <p>Dokumen ini dicetak secara otomatis dari Sistem Pendaftaran</p>
            </div>
        </body>
        </html>
    `;

            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            const iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(printHTML);
            iframeDoc.close();

            iframe.contentWindow.focus();
            iframe.contentWindow.print();

            // Clean up after printing
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 1000);
        }

        // ------------- DATA SUMMARY FOR CONFIRMATION -------------
        function generateDataSummary() {
            const ptData = {
                name: document.getElementById("pt_name").value || "",
                code: document.getElementById("pt_code").value || "",
                status: document.getElementById("pt_status").value || "",
                address: document.getElementById("pt_address").value || "",
                country: document.getElementById("pt_country").value || "",
                province: document.getElementById("pt_province").value || "",
                city: document.getElementById("pt_city").value || ""
            };

            const tendikData = [];
            for (let i = 1; i <= MAX_TENDIK; i++) {
                const id = "tendik_" + i;
                const block = document.getElementById(id);
                if (!block) continue;

                const tendik = {
                    nama: document.getElementById(id + "_nama").value || "",
                    bidang: document.getElementById(id + "_bidang").value || "",
                    course: document.getElementById(id + "_course").value || "",
                    email: document.getElementById(id + "_email").value || ""
                };
                tendikData.push(tendik);
            }

            let summaryHTML = `
                    <div class="data-summary">
                        <h5>Data Perguruan Tinggi:</h5>
                        <p><strong>Nama Perguruan Tinggi</strong> ${ptData.name}</p>
                        <p><strong>Kode Perguruan Tinggi</strong> ${ptData.code}</p>
                        <p><strong>Status:</strong> ${ptData.status}</p>
                        <p><strong>Alamat:</strong> ${ptData.city}, ${ptData.province}, ${ptData.country}</p>
                    </div>
                    <div class="data-summary">
                        <h5>Data Tendik (${tendikData.length} orang):</h5>
                `;

            tendikData.forEach((t, index) => {
                summaryHTML += `
                        <p><strong>Tendik ${index + 1}:</strong> ${t.nama} - ${t.bidang} - ${t.course}</p>
                    `;
            });

            summaryHTML += `</div>`;
            return summaryHTML;
        }

        // ------------- CHECK DUPLICATE DATA -------------
        async function checkDuplicateData() {
            const ptName = document.getElementById("pt_name").value;
            const ptCode = document.getElementById("pt_code").value;

            if (!ptName || !ptCode) {
                return false;
            }

            try {
                // Tampilkan loading
                Swal.fire({
                    title: 'Memeriksa data...',
                    text: 'Sedang mengecek duplikasi',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const url = `${API_BASE}?action=checkDuplicate&pt_name=${encodeURIComponent(ptName)}&pt_code=${encodeURIComponent(ptCode)}`;
                const res = await fetch(url);
                const json = await res.json();

                Swal.close();

                if (json.status === "success") {
                    return json.exists;
                } else {
                    console.error("Duplicate check failed:", json.message);
                    return false; // Jika ada error, allow submission
                }
            } catch (err) {
                Swal.close();
                console.error("Duplicate check error:", err);
                showWarning("Gagal memeriksa data duplikat. Silakan coba lagi.");
                return false; // Jika check gagal, allow submission
            }
        }

        // ------------- CONFIRMATION DIALOG -------------
        async function showConfirmationDialog() {
            const summaryHTML = generateDataSummary();

            const result = await Swal.fire({
                title: 'Konfirmasi Data',
                html: `
                        <div style="text-align: left;">
                            <p>Harap periksa kembali data yang akan dikirim: Pastikan semua data sudah benar sebelum melanjutkan!. Setiap Perguruan Tinggi hanya dapat mendaftarkan data satu kali. </p>
                            ${summaryHTML}
                            <figure class="text-center">
							  <blockquote class="blockquote">
							    <p>Dengan menekan tombol <strong>Lanjutkan Submit</strong>, saya menyatakan dengan sesungguhnya bahwa seluruh data dan dokumen yang telah diisi dan diunggah adalah benar, sah, dan sesuai dengan fakta yang sebenarnya. Saya memahami dan menerima sepenuhnya bahwa segala bentuk kesalahan atau ketidaksesuaian dalam pengisian data dan/atau pengunggahan berkas menjadi tanggung jawab mutlak saya sebagai pengisi formulir.!</p>
							  </blockquote>
                        	</figure>
                    `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Lanjutkan Submit',
                cancelButtonText: 'Cek Lagi Data',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                reverseButtons: true,
                width: '800px'
            });

            return result.isConfirmed;
        }

        // ------------- VALIDATE FORM -------------
        function validateForm() {
            let valid = true;

            // VALIDASI PT
            const requiredPT = [
                "pt_code", "pt_name", "pt_status", "pt_address",
                "pt_country", "pt_province", "pt_city"
            ];

            requiredPT.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value || el.value.trim() === "") {
                    setInvalid(el, "Wajib diisi");
                    valid = false;
                } else {
                    setValid(el);
                }
            });

            if (!valid) {
                showError("Harap lengkapi semua data Perguruan Tinggi");
                window.scrollTo({ top: 0, behavior: "smooth" });
                return false;
            }

            // VALIDASI TENDIK
            let hasTendik = false;
            for (let i = 1; i <= MAX_TENDIK; i++) {
                const id = "tendik_" + i;
                const block = document.getElementById(id);
                if (!block) continue;

                hasTendik = true;
                const fields = [
                    "_bidang", "_nama", "_nik", "_jk", "_tgl_lahir", "_wa",
                    "_email", "_jabatan", "_nomor_sk", "_tgl_sk", "_course", "_link"
                ];

                for (const f of fields) {
                    const el = document.getElementById(id + f);
                    if (!el.value || el.value.trim() === "") {
                        setInvalid(el, "Wajib diisi");
                        valid = false;
                    } else {
                        setValid(el);
                    }
                }

                // Validasi spesifik
                const nikEl = document.getElementById(id + "_nik");
                if (!validateNIK(nikEl.value)) {
                    setInvalid(nikEl, "NIK harus angka 16 digit");
                    valid = false;
                }

                const waEl = document.getElementById(id + "_wa");
                if (!validateWA(waEl.value)) {
                    setInvalid(waEl, "WA harus angka, minimal 10 digit, diawali 08");
                    valid = false;
                }

                const emailEl = document.getElementById(id + "_email");
                if (!isValidEmail(emailEl.value)) {
                    setInvalid(emailEl, "Format email tidak valid");
                    valid = false;
                }
            }

            if (!hasTendik) {
                showError("Minimal 1 data tendik harus diisi");
                return false;
            }

            if (!valid) {
                showError("Periksa kembali data yang belum valid");
                return false;
            }

            return true;
        }

        // ------------- SUBMIT FORM -------------
        window.submitForm = async function() {
            // Validasi form terlebih dahulu
            if (!validateForm()) {
                return;
            }

            // Cek duplikasi data sebelum konfirmasi
            try {
                const isDuplicate = await checkDuplicateData();
                if (isDuplicate) {
                    await Swal.fire({
                        title: 'Data Sudah Terdaftar',
                        html: `
                    <div style="text-align: left;">
                        <p><strong>${document.getElementById("pt_name").value}</strong> sudah terdaftar dalam sistem.</p>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <small>üìù <strong>Note:</strong> Setiap Perguruan Tinggi hanya dapat mendaftarkan data satu kali. Jika ini adalah kesalahan atau perlu update data, silakan hubungi administrator.</small>
                        </div>
                    </div>
                `,
                        icon: 'warning',
                        confirmButtonText: 'Mengerti',
                        confirmButtonColor: '#3085d6',
                        width: '600px'
                    });
                    return;
                }
            } catch (err) {
                // Jika cek duplikasi gagal, tetap lanjutkan (jangan block user)
                console.error("Duplicate check failed, continuing...", err);
            }

            // Tampilkan konfirmasi
            const shouldSubmit = await showConfirmationDialog();

            if (!shouldSubmit) {
                showInfo("Silakan periksa data Anda kembali");
                return;
            }

            // Jika user memilih "Lanjutkan Submit", proses pengiriman data
            await processDataSubmission();
        };

        // ------------- PROCESS DATA SUBMISSION -------------
        async function processDataSubmission() {
            // Process file upload
            const filePtEl = document.getElementById("pt_recommendation");
            let ptRecommendationFile = null;
            if (filePtEl && filePtEl.files && filePtEl.files[0]) {
                const f = filePtEl.files[0];
                if (f.size > 1024 * 1024) {
                    showError("File rekomendasi PT maksimal 1 MB");
                    return;
                }
                const base64 = await new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.onload = () => resolve(r.result.split(",")[1]);
                    r.onerror = reject;
                    r.readAsDataURL(f);
                });
                ptRecommendationFile = {
                    name: f.name,
                    mime: f.type || "application/octet-stream",
                    base64: base64
                };
            }

            // Collect tendik data
            const tendikData = [];
            const tendikLinks = [];
            for (let i = 1; i <= MAX_TENDIK; i++) {
                const id = "tendik_" + i;
                const block = document.getElementById(id);
                if (!block) continue;

                const t = {
                    bidang: document.getElementById(id + "_bidang").value || "",
                    nama: document.getElementById(id + "_nama").value || "",
                    nik: document.getElementById(id + "_nik").value || "",
                    jk: document.getElementById(id + "_jk").value || "",
                    tgl_lahir: document.getElementById(id + "_tgl_lahir").value || "",
                    whatsapp: document.getElementById(id + "_wa").value || "",
                    email: document.getElementById(id + "_email").value || "",
                    jabatan: document.getElementById(id + "_jabatan").value || "",
                    nomor_sk: document.getElementById(id + "_nomor_sk").value || "",
                    tgl_sk: document.getElementById(id + "_tgl_sk").value || "",
                    course: document.getElementById(id + "_course").value || "",
                    link: document.getElementById(id + "_link").value || "" // ‚Üê TAMBAHKAN INI
                };

                tendikData.push(t);
            }

            // Prepare data for success message
            lastSubmittedData = {
                pt: {
                    name: document.getElementById("pt_name").value || "",
                    code: document.getElementById("pt_code").value || "",
                    status: document.getElementById("pt_status").value || "",
                    address: document.getElementById("pt_address").value || "",
                    country: document.getElementById("pt_country").value || "",
                    province: document.getElementById("pt_province").value || "",
                    city: document.getElementById("pt_city").value || "",
                    hasFile: !!ptRecommendationFile,
                    recommendationLink: "" // ‚Üê INI AKAN DIISI OLEH BACKEND
                },
                tendik: tendikData
            };

            // Prepare payload
            const payload = {
                pt_name: document.getElementById("pt_name").value || "",
                pt_code: document.getElementById("pt_code").value || "",
                pt_status: document.getElementById("pt_status").value || "",
                pt_address: document.getElementById("pt_address").value || "",
                pt_city: document.getElementById("pt_city").value || "",
                pt_province: document.getElementById("pt_province").value || "",
                pt_country: document.getElementById("pt_country").value || "",
                pt_recommendation_file: ptRecommendationFile || { name: "", mime: "", base64: "" },
                tendik: tendikData,
                files: tendikData.map(t => ({ link: t.link || "" })) // ‚Üê TAMBAHKAN INI
            };

            try {
                showLoading();

                const res = await fetch(API_BASE, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });

                const json = await res.json();

                Swal.close();

                if (json.status === "success") {
                    // Update lastSubmittedData dengan link dari backend
                    lastSubmittedData = {
                        pt: {
                            name: document.getElementById("pt_name").value || "",
                            code: document.getElementById("pt_code").value || "",
                            status: document.getElementById("pt_status").value || "",
                            address: document.getElementById("pt_address").value || "",
                            country: document.getElementById("pt_country").value || "",
                            province: document.getElementById("pt_province").value || "",
                            city: document.getElementById("pt_city").value || "",
                            hasFile: !!ptRecommendationFile,
                            recommendationLink: json.data.pt_recommendation_link || "" // ‚Üê LINK DARI BACKEND
                        },
                        tendik: tendikData
                    };

                    showSuccess("Data berhasil disimpan!", lastSubmittedData); // Tambahkan message sebagai parameter pertama
                    // Reset form
                    document.getElementById("mainForm").reset();
                    tendikCount = 0;
                    document.getElementById("tendikContainer").innerHTML = "";
                    // Re-add one tendik block
                    addTendik();
                } else {
                    showError("Server error: " + (json.message || "Terjadi kesalahan"));
                }
            } catch (err) {
                Swal.close();
                console.error("submit error:", err);
                showError("Gagal mengirim data. Periksa koneksi internet Anda.");
            }
        };

    })();
    </script>
    <div id="footer"></div>
</body>

</html>
